<!DOCTYPE html>
<!--
  ~ Copyright (c) SAS Institute Inc.
  ~  Licensed under the Apache License, Version 2.0 (the "License");
  ~  you may not use this file except in compliance with the License.
  ~  You may obtain a copy of the License at
  ~
  ~  http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~  Unless required by applicable law or agreed to in writing, software
  ~  distributed under the License is distributed on an "AS IS" BASIS,
  ~  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~  See the License for the specific language governing permissions and
  ~  limitations under the License.
  ~
  ~
  -->

<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Report 1, Page 1</title>
    <link rel="stylesheet" type="text/css" href="./app.css">

    <script src="https://unpkg.com/babel-core@5.8.38/browser.min.js"></script>
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
    <!-- this brings in the raf library -->
    <script src="https://unpkg.com/restaf/dist/restaf.min.js"></script>
    <script src="/restafServerInfo"></script>
    <script type="text/javascript" src="/shared/env.js"></script>
    <script type="text/javascript" src="/shared/showAlert.js"></script>
    <style>
        .notes {
            border: 2px;
            background: cyan;
        }
        .left{
            float:left;
            flex-grow: 1;
            overflow:hidden;
            border-style: solid;
            border: 5px;
            height: 80%;
        }
        .right{
            float:left;
            flex-grow: 1;
            overflow:hidden;
            border-style: solid;
            border: 5px;
            height: 100%;
        }

        .imagediv {
            border-style: groove;
        }
        .container {
            height: 100vh;
            width: auto;
        }
        .grid {
            display: table;
            width: calc(100% + 1.75rem);
            border-collapse: separate;
            border-spacing: 1rem;
            margin: -1rem;
            height: inherit;
        }
        .gridRow {
            display: table-row;
        }
        .gridCell {
            display: table-cell;
            width: 50%;
            padding-bottom: 56.25%;
            position: relative;
        }
        .component {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            flex-flow: column;
        }
        .componentIframe {
            border: 1px solid #000000;
            margin-top: 0.5rem;
            display: flex;
            align-items: flex-start;
            flex: 1;
        }
        .componentHeader {
            height: 20px;
            width: 100%;
            display: flex;
            align-items: flex-start;
        }

    </style>
</head>
<body>

<script type="text/javascript">

    let reportsService      = null;
    let reportImagesService = null;
    let reportsList         = null;
    let sectionName         = null;
    let reportNo            = 0;
    let currentHref         = null;

    //
    // create image payload
    //

    async function getImage() {
        let page = document.getElementById( "page" ).value;
        reportNo = document.getElementById( "reportno" ).value;
        let job = await store.apiCall( reportImagesService.links( 'createJob' ), imagePayload( reportsList, reportNo, page ) );
        debugger;
        let status = await store.jobState( job, { qs: { wait: 1.5} } , 5, 2 );

        if ( status.data !== 'completed' ) {
            throw `Job failed ${status.data}`;
        }

        sectionName = status.job.items( status.job.itemsList( 0 ), 'data', 'sectionName' );
        let image  = await store.apiCall( status.job.itemsCmd( status.job.itemsList( 0 ), 'image' ) )
        viewer(image.items());

    }

    function imagePayload( reportsList, index, page ) {
        console.log(reportsList.itemsList().size );
        let uri = reportsList.itemsCmd( reportsList.itemsList( index ), 'self', 'link', 'uri' );
        return {
            data: {
                reportUri      : uri,
                sectionIndex   : page,
                layoutType: 'entireSection',
                size: "400x400"
            }
         } ;
    }
    
    function viewer( image ) {
        debugger;
        let href = reportsList.itemsCmd( reportsList.itemsList( reportNo ), 'self', 'link', 'href' ) ;
        makeLink ( href, sectionName, 'freport',    'full',   '_self', 'Full report in same Tab' );
        makeLink ( href, sectionName, 'tabfreport', 'full',   '_blank',  'Full report in a new Tab' );
        addSvg( image );
    }
    function addSvg( svgdata ) {
        let svg = document.getElementById( `svg0` );
        svg.innerHTML =  svgdata;
        debugger;
        let box = svg.getBBox();
        let viewBox = [box.x, box.y, box.width, box.height ].join( " " );
        svg.setAttribute( "viewBox", viewBox );
        svg.setAttribute( "preserveAspectRatio", "none" );
    }


    function makeLink ( reportHref, page, element, reporttype, target, label ) {
        let result;
        let href = `${VIYA_HOST}/SASReportViewer/?reportUri=${reportHref}`;
        href = href + "&page=" + page;
        href = href + "&appSwitcherDisabled=true&reportViewOnly=true";
        currentHref = href;
        result = `<a href="${href}" target="${target}" > ${label} </a>`;
    
        document.getElementById( element ).innerHTML = result;

}
    // start

    function getImageHandler () {
        getImage()
            .catch ( err  => showAlert( err ) )
    }
    let gotoGetImage = getImageHandler.bind( this );

    function getReportHandler () {
        document.getElementById('frame0').style.display ='block';
        document.getElementById('svg0').style.display = 'none';
        document.getElementById('frame0').setAttribute('src',currentHref );
    }
    let gotoGetReport = getReportHandler.bind( this );



    async function setup() {
        debugger;
        let msg = await store.logon(null);

        let services   = await store.addServices ('reports', 'reportImages');
        reportsService = services.reports;
        reportImagesService = services.reportImages;

        debugger;
        reportsList = await store.apiCall( reportsService.links( 'reports' ) );
        return true;
    }

    let store = restaf.initStore( );
    debugger;
    setup() 
            .then (r => console.log( r ))
            .catch (err => showAlert(err));


</script>

    <div id="container" class="content" >

        <p id="freport" ></p>
        <p id="ereport"> </p>

        <p id="tabfreport"> </p>

        Report No: <input type="number" name="Report" id="reportno" value="0" >
        Section Number: <input type="number" name="Section" id="page" value="0" >
        <button id="getimage" onclick="gotoGetImage();"> Get Image </button>
        <button id="getreport" onclick="gotoGetReport();"> Get report </button>
        <div class="wrapper">
            <div id="left">
                <p id="repLink0"> </p>
                <div id="image0" class="imagediv">
                    <svg id="svg0"> </svg>
                    <iframe id="frame0" class="componentIframe" allowfullscreen></iframe>

                </div>
            </div>


     </div>


</body>
</html>