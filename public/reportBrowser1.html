
<!DOCTYPE html>
<!--
  ~ Copyright (c) SAS Institute Inc.
  ~  Licensed under the Apache License, Version 2.0 (the "License");
  ~  you may not use this file except in compliance with the License.
  ~  You may obtain a copy of the License at
  ~
  ~  http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~  Unless required by applicable law or agreed to in writing, software
  ~  distributed under the License is distributed on an "AS IS" BASIS,
  ~  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~  See the License for the specific language governing permissions and
  ~  limitations under the License.
  ~
  ~
  -->

<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Report 1, Page 1</title>
    <link rel="stylesheet" type="text/css" href="./app.css">

    <script src="https://unpkg.com/babel-core@5.8.38/browser.min.js"></script>
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
    <!-- this brings in the raf library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/16.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/16.2.0/umd/react-dom.production.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/6.26.0/polyfill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.38/browser.min.js"></script>


    <script type="text/javascript" src="/shared/env.js"></script>
    <script type="text/javascript" src="/shared/showAlert.js"></script>
    <script type="text/javascript" src="/shared/util.js"></script>
    <script src="https://unpkg.com/restaf/dist/restaf.min.js"></script>
    <script src="https://unpkg.com/restaf-uicomponents/dist/restaf-uicomponents.js"></script>

    <style>
        .notes {
            border: 2px;
            background: cyan;
        }
        #left{
            float:left;
            width:80%;
            overflow:hidden;
            border-style: solid;
            border: 5px;
            height: 80%;
        }
        #right{
            float:left;
            width:50%;
            overflow:hidden;
            border-style: solid;
            border: 5px;
            height: 100%;
        }
        .imagediv {
            border-style: groove;
        }
    </style>
</head>
<body>

<script type="text/javascript">

    let reportsService      = null;
    let reportImagesService = null;
    let reportsList         = null;
    let sectionName         = null;
    let reportNo            = 0;

    var store = restaf.initStore( );

    store.logon( null )
         .then( msg        => store.addServices( 'reports', 'reportImages' ) )
         .then ( services  => {
             reportsService = services.reports; /* use this to get list of reports */
             reportImagesService = services.reportImages; /* use this to create images */
             return store.apiCall( reportsService.links( 'reports' ) ); /* get list of reports */
         } )
         .then ( reportsL => {
             reportsList = reportsL; /* cache the current list */
             makeSelect( ); /* make a dropdown list of reports */
         } )
         .catch ( err   => {
             alert( err );
         } );

    //
    // create image payload when user selects the 'Get Image'  button
    //

    function getImage() {
        let page = document.getElementById( "page" ).value;
        reportNo = document.getElementById( "reportNo" ).selectedIndex;

        //
        // run job to create image
        store.apiCall( reportImagesService.links( 'createJob' ), imagePayload( reportsList, reportNo, page ) )
             .then ( job   => store.jobState ( job ,{qs: {wait: 2 } }, 10 ) ) /*  default long poll times, max tries = 10  */
             .then( status => {
                 if ( status.running > 0  ) {
                     throw {Sorry: `Job still running. Try again`}
                 } else {
                     if ( status.detail.failed > 0 ) {
                         throw {Error: `Job failed`}
                     } else {
                         return status.jobState.job;
                     }
                 }
             } )
             .then( newJob => {
                 //
                 // Note: waitOnJob will return a refreshed self
                 //
                 sectionName = newJob.items( newJob.itemsList( 0 ), 'data', 'sectionName' ); /* name of section */
                 return store.apiCall( newJob.itemsCmd( newJob.itemsList( 0 ), 'image' ) ) /* get the actual svg */
             } )
             .then ( image  =>  viewer( image ) )
             .catch ( err   => {
                 alert( JSON.stringify( err, null, 4 ) );
             } );

    }

    //
    // This is based on an earlier version of the image service
    // If deploying the latest image service you have to change this payload definition
    //
    function imagePayload( reportsList, index, page ) {
        let uri = reportsList.itemsCmd( reportsList.itemsList( index ), 'self', 'link', 'uri' );
        return {
            data: {
                reportUri      : uri,
                layoutType     : 'entireSection',
                size           : "400x400",
                sectionIndex   : page - 1
            }
        } ;
    }

    //
    // Replace with a viewer you like...
    //
    function viewer( image ) {
        debugger;
        let href = reportsList.itemsCmd( reportsList.itemsList( reportNo ), 'self', 'link', 'href' ) ;
        makeLink ( href, sectionName, 'tabereport', '_blank',  'Open live report in a new Tab');

        //
        // put the svg into the image element
        //
        addImage( 0, image.items() );
    }

    //
    /// create 'a' element for linking to the report
    //
    function makeLink ( reportHref, page, element, target, label ) {
        let href = `${VIYA_HOST}/SASReportViewer/?reportUri=${reportHref}`;
        href     = href + "&page=" + page + "&appSwitcherDisabled=true&reportViewOnly=true";
        document.getElementById( element ).innerHTML = `<a href="${href}" target="${target}" > ${label} </a>`;
    }

    // create a select list for reports
    // Note that this is a simple case and does not handle pagination.
    // See restAF document on how to handle pagination

    function makeSelect() {
        var select = document.getElementById( 'reportNo' );
        reportsList.itemsList().forEach( v => {
            let option = document.createElement( "option" );
            option.text = v;
            select.options.add( option );
        } );
    }

    function addImage( id, svgdata ) {
        let svg = document.getElementById( `svg${id}` );
        svg.innerHTML =  svgdata;
        debugger;
        let box = svg.getBBox();
        let viewBox = [box.x, box.y, box.width, box.height ].join( " " );
        svg.setAttribute( "viewBox", viewBox );
        svg.setAttribute( "preserveAspectRatio", "none" );
    }
</script>

<!-- Visual part of the demo -->

<div id="container" class="content" >
    <h1> A report browser built with restAF </h1>

    Report: <select id="reportNo"> </select>
    Section: <input type="number" name="Section" id="page" value="1" >
    <button id="getimage" onclick="getImage();"> Get Image </button>

    <div class="wrapper">
        <div id="left">
            <p id="tabereport"> </p>
            <div id="image0" class="imagediv">
                <svg id="svg0"> </svg>
            </div>
        </div>
    </div>


</div>


</body>
</html>